function plotDiatom_vulnerability(sim)

%
% Run with varying vulnerability. Check generalist/diatom ratio
% and active/passive ratio
%
%p = setupNUMmodel([0.5 2], [10 1000], 6,6,1, bParallel= true); % A fast version of the NUM setup
p = setupNUMmodel(bParallel=true);
%parinit = [0.076511, 19.974500, 0.014468];
%objExpected = [1 1 1 800 200 1000]; % Pico, POC, copepods; NPP , eutrophic oligotrophic and seasonal


%%
% diatoms

sims = {};
diatomVulnerability = linspace(0,1,5);
%load NUMmodel.mat
%%


figure(1)
width=8; %figure width in cm
heightf=18; %figure height in cm
set(gcf,'Renderer','Painters','Units','centimeters',...
'Position',[0 0 width heightf],...
'PaperPositionMode','auto','Name','Functional groups');

cmap=flip(cmocean('deep',100));
ccmap=cmap(2:end,:);      



tcl = tiledlayout(length(diatomVulnerability),1,'TileSpacing','tight');
title(tcl,"Diatom:phytoplankton ratio")


for i = 1:length(diatomVulnerability)
    substituteInputParameters('palatability','input_diatoms', num2str(diatomVulnerability(i)));

    p = setupNUMmodel(bParallel=true);
    p = parametersGlobal(p);

    p.tEnd = 3*365;
    sims{i} = simulateGlobal(p,sim,bCalcAnnualAverages=true);

    tile = nexttile
    sims{i} = plotGlobalPhytoplankton(sims{i}, bPlot=false, bOnlySurface=true);
    %plotGlobalGeneralistsDiatoms(sims{i},sProjection='eckert4');
    %drawnow

    %Bgeneralists = calcBiomassGroup(sims{i},5);
    %Bdiatoms = calcBiomassGroup(sims{i},3);

    %Diatomratio(i,:,:) = Bdiatoms./(Bgeneralists+Bdiatoms);
    %panelGlobal(sim.x, sim.y, squeeze(Diatomratio(i,:,:)),0:0.1:1, sProjection='eckert4')

    ixTime = find(sims{i}.t>(max(sims{i}.t)-365));
    panelGlobal(sim.x, sim.y, mean(sims{i}.Diatomratio(ixTime,:,:),1), ...
         sUnits="", sProjection='eckert4');
     clim([0 1])
     colormap(tile,ccmap)
    drawnow

    %fprintf("Diatom fraction %f\n", ...
    %    [Diatomratio(i)]);    
end
!cp ../input/input_orig.h ../input/input.h

